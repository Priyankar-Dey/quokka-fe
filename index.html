<div id="chat-wrapper" style="
  width: 100%;
  height: 100%;
  background: #0b0b0b;
  color: #f0f0f0;
  font-family: 'Segoe UI', sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  padding: 15px 5vw 40px 5vw;
  box-sizing: border-box;
">
  <h2 style="color: #00bfa6; font-weight: 700; font-size: 2rem; margin-bottom: 20px;">
    QUOKKA The EternaL Archives
  </h2>

  <div id="chat-box" style="
    flex: 1;
    width: 90%;
    max-width: 1300px;
    border: 1px solid #222;
    border-radius: 14px;
    background: #000;
    padding: 20px;
    overflow-y: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
  "></div>

  <style>
    #chat-box::-webkit-scrollbar { display: none; }
  </style>

  <div style="display: flex; gap: 12px; width: 90%; max-width: 1300px; margin-top: 20px;">
    <input id="user-input" type="text" placeholder="Type your question..."
      style="flex: 1; padding: 14px; border-radius: 10px; border: 1px solid #333; background: #1a1a1a; color: white; font-size: 1rem;">
    <button id="send-btn"
      style="padding: 14px 24px; border-radius: 10px; background: #00bfa6; border: none; color: white; cursor: pointer; font-size: 1rem; font-weight: 600;">
      Send
    </button>
  </div>
</div>

<script>
window.onload = function () {
  const chatBox = document.getElementById("chat-box");
  const sendBtn = document.getElementById("send-btn");
  const userInput = document.getElementById("user-input");
  const backendURL = "https://gemini-backend-58wg.onrender.com/chat";

  // üëã Custom user name
  const userName = "Priyankar"; // TODO: replace with dynamic name later

  // Greet on load
  appendMessage("bot", `üëã Welcome back, ${userName}! The archives await your curiosity.`);

  // Send listeners
  sendBtn.addEventListener("click", sendMessage);
  userInput.addEventListener("keypress", function (e) {
    if (e.key === "Enter") sendMessage();
  });

  async function sendMessage() {
    const userMessage = userInput.value.trim();
    if (!userMessage) return;

    appendMessage("user", userMessage);
    userInput.value = "";
    appendMessage("bot", "‚è≥ Searching the archives...");

    try {
      const response = await fetch(backendURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: userMessage, username: userName }), // send username too
      });

      const data = await response.json();
      const botReply = data.reply || "üìö The shelves seem quiet for now.";
      replaceLastMessage("bot", formatText(botReply));
    } catch (error) {
      replaceLastMessage("bot", "‚ö†Ô∏è Connection to the archives failed.");
    }
  }

  function appendMessage(sender, text) {
    const msgDiv = document.createElement("div");
    msgDiv.style.margin = "12px 0";
    msgDiv.innerHTML =
      sender === "user"
        ? `<div style="background:#00bfa6;color:#fff;padding:12px 16px;border-radius:10px;max-width:80%;margin-left:auto;">${text}</div>`
        : `<div style="background:#222;color:#ddd;padding:12px 16px;border-radius:10px;max-width:90%;white-space:pre-line;">${text}</div>`;
    chatBox.appendChild(msgDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function replaceLastMessage(sender, text) {
    const messages = chatBox.querySelectorAll("div");
    const lastMsg = messages[messages.length - 1];
    lastMsg.innerHTML =
      sender === "bot"
        ? `<div style="background:#222;color:#ddd;padding:12px 16px;border-radius:10px;max-width:90%;white-space:pre-line;">${text}</div>`
        : `<div style="background:#00bfa6;color:#fff;padding:12px 16px;border-radius:10px;max-width:80%;margin-left:auto;">${text}</div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  // ---- Format Output ----
  function formatText(text) {
    return text
      .replace(/\$/g, "")
      .replace(/\\left|\\right/g, "")
      .replace(/\\\\/g, "<br>")
      .replace(/\\times/g, "√ó")
      .replace(/\\div/g, "√∑")
      .replace(/\\cdot/g, "¬∑")
      .replace(/\\pm/g, "¬±")
      .replace(/\\pi/g, "œÄ")
      .replace(/\\infty/g, "‚àû")
      .replace(/\\le/g, "‚â§")
      .replace(/\\ge/g, "‚â•")
      .replace(/\\neq/g, "‚â†")
      .replace(/\\approx/g, "‚âà")
      .replace(/\\in/g, "‚àà")
      .replace(/\\xi/g, "Œæ")
      .replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, "($1 √∑ $2)")
      .replace(/\\sqrt\{([^}]+)\}/g, "‚àö($1)")
      .replace(/\\sum_\{([^}]+)\}\^\{([^}]+)\}/g, "Œ£($1‚Üí$2)")
      .replace(/\\begin\{pmatrix\}/g, "[")
      .replace(/\\end\{pmatrix\}/g, "]")
      .replace(/&/g, "  ")
      .replace(/\^\{([^}]+)\}/g, "<sup>$1</sup>")
      .replace(/\^([0-9a-zA-Z])/g, "<sup>$1</sup>")
      .replace(/_\{([^}]+)\}/g, "<sub>$1</sub>")
      .replace(/_([0-9a-zA-Z])/g, "<sub>$1</sub>")
      .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
      .replace(/\n\s*[-‚Ä¢]\s*/g, "<br>‚Ä¢ ")
      .replace(/\n{2,}/g, "<br><br>")
      .replace(/\n/g, "<br>");
  }
};
</script>




